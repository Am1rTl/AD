{{- $existingPostgresSecret := lookup "v1" "Secret" .Release.Namespace (include "warehouse.secretName.postgres" .) -}}
{{- $existingTiServerSecret := lookup "v1" "Secret" .Release.Namespace (include "warehouse.secretName.tiServer" .) -}}
{{- $existingAuthServerSecret := lookup "v1" "Secret" .Release.Namespace (include "warehouse.secretName.authServer" .) -}}
{{- $existingWarehouseSecret := lookup "v1" "Secret" .Release.Namespace (include "warehouse.secretName.warehouse" .) -}}
{{- $existingGatewayServerSecret := lookup "v1" "Secret" .Release.Namespace (include "warehouse.secretName.gatewayServer" .) -}}

{{- $postgresPassword := "" -}}
{{- $tiServerDbPassword := "" -}}
{{- $authServerDbPassword := "" -}}
{{- $warehouseDbPassword := "" -}}
{{- $gatewayServerDbPassword := "" -}}
{{- $warehouseClientSecret := "" -}}
{{- $gatewayClientSecret := "" -}}
{{- $warehouseSessionSecret := "" -}}
{{- $gatewaySessionSecret := "" -}}

{{- if $existingPostgresSecret -}}
  {{- $postgresPassword = index $existingPostgresSecret.data "postgres-password" | b64dec -}}
  {{- $tiServerDbPassword = index $existingPostgresSecret.data "tiserver-password" | b64dec -}}
  {{- $authServerDbPassword = index $existingPostgresSecret.data "authserver-password" | b64dec -}}
  {{- $warehouseDbPassword = index $existingPostgresSecret.data "warehouse-password" | b64dec -}}
  {{- $gatewayServerDbPassword = index $existingPostgresSecret.data "gateway-password" | b64dec -}}
{{- else -}}
  {{- $postgresPassword = randAlphaNum 32 -}}
  {{- $tiServerDbPassword = randAlphaNum 32 -}}
  {{- $authServerDbPassword = randAlphaNum 32 -}}
  {{- $warehouseDbPassword = randAlphaNum 32 -}}
  {{- $gatewayServerDbPassword = randAlphaNum 32 -}}
{{- end -}}

{{- if $existingAuthServerSecret -}}
  {{- $warehouseClientSecret = index $existingAuthServerSecret.data "warehouse-client-secret" | b64dec -}}
  {{- $gatewayClientSecret = index $existingAuthServerSecret.data "gateway-client-secret" | b64dec -}}
{{- else -}}
  {{- $warehouseClientSecret = randAlphaNum 32 -}}
  {{- $gatewayClientSecret = randAlphaNum 32 -}}
{{- end -}}

{{- if $existingWarehouseSecret -}}
  {{- $warehouseSessionSecret = index $existingWarehouseSecret.data "session-secret" | b64dec -}}
{{- else -}}
  {{- $warehouseSessionSecret = randAlphaNum 32 -}}
{{- end -}}

{{- if $existingGatewayServerSecret -}}
  {{- $gatewaySessionSecret = index $existingGatewayServerSecret.data "session-secret" | b64dec -}}
{{- else -}}
  {{- $gatewaySessionSecret = randAlphaNum 32 -}}
{{- end -}}

{{- if .Values.postgresql.enabled }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "warehouse.secretName.postgres" . }}
  labels:
    {{- include "warehouse.labels" . | nindent 4 }}
type: Opaque
stringData:
  postgres-password: {{ $postgresPassword | quote }}
  tiserver-password: {{ $tiServerDbPassword | quote }}
  authserver-password: {{ $authServerDbPassword | quote }}
  warehouse-password: {{ $warehouseDbPassword | quote }}
  gateway-password: {{ $gatewayServerDbPassword | quote }}
{{- end }}

{{- if .Values.tiServer.enabled }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "warehouse.secretName.tiServer" . }}
  labels:
    {{- include "warehouse.componentLabels" (dict "component" "ti-server" "context" .) | nindent 4 }}
type: Opaque
stringData:
  db-user: {{ .Values.tiServer.db.user | quote }}
  db-password: {{ $tiServerDbPassword | quote }}
{{- end }}

{{- if .Values.authServer.enabled }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "warehouse.secretName.authServer" . }}
  labels:
    {{- include "warehouse.componentLabels" (dict "component" "auth-server" "context" .) | nindent 4 }}
type: Opaque
stringData:
  db-user: {{ .Values.authServer.db.user | quote }}
  db-password: {{ $authServerDbPassword | quote }}
  warehouse-client-secret: {{ $warehouseClientSecret | quote }}
  gateway-client-secret: {{ $gatewayClientSecret | quote }}
{{- end }}

{{- if .Values.warehouse.enabled }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "warehouse.secretName.warehouse" . }}
  labels:
    {{- include "warehouse.componentLabels" (dict "component" "warehouse" "context" .) | nindent 4 }}
type: Opaque
stringData:
  db-user: {{ .Values.warehouse.db.user | quote }}
  db-password: {{ $warehouseDbPassword | quote }}
  oauth-client-secret: {{ $warehouseClientSecret | quote }}
  session-secret: {{ $warehouseSessionSecret | quote }}
{{- end }}

{{- if .Values.gatewayServer.enabled }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "warehouse.secretName.gatewayServer" . }}
  labels:
    {{- include "warehouse.componentLabels" (dict "component" "gateway-server" "context" .) | nindent 4 }}
type: Opaque
stringData:
  db-user: {{ .Values.gatewayServer.db.user | quote }}
  db-password: {{ $gatewayServerDbPassword | quote }}
  oauth-client-secret: {{ $gatewayClientSecret | quote }}
  session-secret: {{ $gatewaySessionSecret | quote }}
{{- end }}
